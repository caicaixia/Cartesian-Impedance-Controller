<html><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<title>workspace: Cartesian Impedance Controller</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="jquery.js"></script>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Cartesian Impedance Controller </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a href="https://github.com/matthias-mayr/Cartesian-Impedance-Controller/actions/workflows/build_code.yml"></a> <a href="https://matthias-mayr.github.io/Cartesian-Impedance-Controller/"></a> </p><h2>Description</h2>
<p>This project is an implementation of Cartesian impedance control for robotic manipulators. It is a type of control strategy that sets a dynamic relationship between contact forces and the position of a robot arm, making it suitable for collaborative robots. It is particularily useful when the interesting dimensions in the workspace are in the Cartesian space.</p>
<p>The controller is developed using the seven degree-of-freedom (DoF) robot arm <code>LBR iiwa</code> by <code>KUKA AG</code> and has also been tested <code>Franka Emika Robot (Panda)</code> both in reality and simulation.</p>
<p>The implementation consists of a</p><ol type="1">
<li>base library that has few dependencies and can e.g. be directly integrated into software such as the DART simulator and a</li>
<li>ROS control integration on top of it.</li>
</ol>
<h3>Short Pitch at ROSCon:</h3>
<p><a href="http://www.youtube.com/watch?v=Q4aPm4O_9fY" title="Cartesian Impedance Controller ROSCon 2022 Lightning Talk"></a></p>
<p><a href="http://www.youtube.com/watch?v=Q4aPm4O_9fY">http://www.youtube.com/watch?v=Q4aPm4O_9fY</a></p>
<h2>Features</h2>
<ul>
<li>Configurable stiffness values along all Cartesian dimensions at runtime</li>
<li>Configurable damping factors along all Cartesian dimensions at runtime</li>
<li>Change reference pose at runtime</li>
<li>Apply Cartesian forces and torques at runtime</li>
<li>Optional filtering of stiffnesses, pose and wrenches for smoother operation</li>
<li>Handling of joint trajectories with nullspace configurations, e.g. from MoveIt</li>
<li>Jerk limitation</li>
<li>Separate base library that can be integrated in non-ROS environments</li>
<li>Interface to ROS messages and dynamic_reconfigure for easy runtime configuration</li>
</ul>
<div class="image">
<img src="flowchart.png" alt="flowchart.png"/>
</div>
<h2>Torques</h2>
<p>The torque signal commanded to the joints of the robot is composed by the superposition of three joint-torque signals:</p><ul>
<li>The torque calculated for Cartesian impedance control with respect to a Cartesian pose reference in the frame of the EE of the robot (<code>tau_task</code>).</li>
<li>The torque calculated for joint impedance control with respect to a desired configuration and projected in the null-space of the robot's Jacobian, so it should not affect the Cartesian motion of the robot's end-effector (<code>tau_ns</code>).</li>
<li>The torque necessary to achieve the desired external force command (<code>cartesian_wrench</code>), in the frame of the EE of the robot (<code>tau_ext</code>).</li>
</ul>
<h2>Limitations</h2>
<ul>
<li>Joint friction is not accounted for</li>
<li>Stiffness and damping values along the Cartesian dimensions are uncoupled</li>
<li>No built-in gravity compensation for tools or workpieces (can be achieved by commanded a wrench)</li>
</ul>
<h2>Prerequisites</h2>
<h3>Required</h3>
<ul>
<li><a href="https://eigen.tuxfamily.org/index.php?title=Main_Page">Eigen</a></li>
</ul>
<h3>ROS Controller</h3>
<p>We use <code>RBDyn</code> to calculate forward kinematics and the Jacobian.</p>
<ul>
<li><a href="https://www.ros.org/">ROS</a></li>
<li><a href="https://github.com/jrl-umi3218/RBDyn">RBDyn</a></li>
<li><a href="https://github.com/jrl-umi3218/mc_rbdyn_urdf">mc_rbdyn_urdf</a></li>
<li><a href="https://github.com/jrl-umi3218/SpaceVecAlg">SpaceVecAlg</a></li>
</ul>
<p>The installation steps are automated in <code>scripts/install_dependencies.sh</code>:</p>
<h2>Controller Usage in ROS</h2>
<p>Assuming that there is an <a href="https://catkin-tools.readthedocs.io/en/latest/quick_start.html#initializing-a-new-workspace">initialized catkin workspace</a> you can clone this repository, install the dependencies and compile the controller.</p>
<p>After cloning this repository in your catkin workspace, execute these commands:</p>
<div class="fragment"><div class="line">cd catkin_ws</div><div class="line">src/cartesian_impedance_controller/scripts/install_dependencies.sh</div><div class="line">rosdep install --from-paths src --ignore-src --rosdistro=${ROS_DISTRO} -y</div><div class="line">catkin build # or catkin_make</div><div class="line">source devel/setup.bash</div></div><!-- fragment --><p>This allows you to add a controller configuration for the controller type <code>cartesian_impedance_controller/CartesianImpedanceController</code>.</p>
<h3>Configuration file</h3>
<p>When using the controller it is a good practice to describe the parameters in a <code>YAML</code> file and load it. Usually this is already done by your robot setup - e.g. for <a href="https://github.com/epfl-lasa/iiwa_ros/">iiwa_ros</a> that is <a href="https://github.com/epfl-lasa/iiwa_ros/blob/master/iiwa_control/config/iiwa_control.yaml">here</a>. Here is a template of what needs to be in that YAML file that can be adapted: </p><div class="fragment"><div class="line">CartesianImpedance_trajectory_controller:</div><div class="line">  type: cartesian_impedance_controller/CartesianImpedanceController</div><div class="line">  joints:                               # Joints to control</div><div class="line">    - iiwa_joint_1</div><div class="line">    - iiwa_joint_2</div><div class="line">    - iiwa_joint_3</div><div class="line">    - iiwa_joint_4</div><div class="line">    - iiwa_joint_5</div><div class="line">    - iiwa_joint_6</div><div class="line">    - iiwa_joint_7</div><div class="line">  end_effector: iiwa_link_ee            # Link to control arm in</div><div class="line">  update_frequency: 500                 # Controller update frequency in Hz</div><div class="line">  # Optional parameters - the mentioned values are the defaults</div><div class="line">  dynamic_reconfigure: true             # Starts dynamic reconfigure server</div><div class="line">  handle_trajectories: true             # Accept traj., e.g. from MoveIt</div><div class="line">  robot_description: /robot_description # In case of a varying name</div><div class="line">  wrench_ee_frame: iiwa_link_ee         # Default frame for wrench commands</div><div class="line">  delta_tau_max: 1.0                    # Max. commanded torque diff between steps in Nm</div><div class="line">  filtering:                            # Update existing values (0.0 1.0] per s</div><div class="line">    nullspace_config: 0.1               # Nullspace configuration filtering</div><div class="line">    pose: 0.1                           # Reference pose filtering</div><div class="line">    stiffness: 0.1                      # Cartesian and nullspace stiffness</div><div class="line">    wrench: 0.1                         # Commanded torque</div><div class="line">  verbosity:</div><div class="line">    verbose_print: false                # Enables additional prints</div><div class="line">    state_msgs: false                   # Messages of controller state</div><div class="line">    tf_frames: false                    # Extra tf frames</div></div><!-- fragment --><h3>Startup</h3>
<p>To start up with this controller, eventually the controller spawner needs to load the controller. Typically this is baked into the robot driver. For example if using the YAML example above, with <a href="https://github.com/epfl-lasa/iiwa_ros/">iiwa_ros</a>, this can be achieved with command:</p>
<div class="fragment"><div class="line">roslaunch iiwa_gazebo iiwa_gazebo.launch controller:=CartesianImpedance_trajectory_controller</div></div><!-- fragment --><h3>Changing parameters with Dynamic Reconfigure</h3>
<p>If it is not deactivated, the controller can be configured with <a href="http://wiki.ros.org/dynamic_reconfigure">dynamic_reconfigure</a> both with <a href="http://wiki.ros.org/dynamic_reconfigure#dynamic_reconfigure.2Fgroovy.dynparam_command-line_tool">command line tools</a> as well as the graphical user interface <a href="http://wiki.ros.org/rqt_reconfigure">rqt_reconfigure</a>. To start the latter you can run: </p><div class="fragment"><div class="line">rosrun rqt_reconfigure rqt_reconfigure</div></div><!-- fragment --><p>There are several entries:</p><ul>
<li><code>cartesian_wrench_reconfigure</code></li>
<li><code>damping_factors_reconfigure</code></li>
<li><code>stiffness_reconfigure</code></li>
</ul>
<p>For applying wrench, the <code>apply</code> checkbox needs to be ticked for the values to be used. Damping and stiffness changes are only updated when the <code>update</code> checkbox is ticked, allowing to configure changes before applying them. Note that the end-effector reference pose can not be set since it usually should follow a smooth trajectory.</p>
<h3>Changing parameters with ROS messages</h3>
<p>In addition to the configuration with <code>dynamic_reconfigure</code>, the controller configuration can always be adapted by sending ROS messages. Outside prototyping this is the main way to parameterize it.</p>
<p>The instructions below use <code>${controller_ns}</code> for the namespace of your controller. This can for example be <code>/cartesian_impedance_controller</code>. If you want to copy the example commands 1:1, you can set an environment variable with <code>export controller_ns=/&lt;your_namespace&gt;</code>.</p>
<h4>End-effector reference pose</h4>
<p>New reference poses can be sent to the topic <code>${controller_ns}/reference_pose</code>. They are expected to be in the root frame of the robot description which is often <code>world</code>. The root frame can be obtained from the parameter server with <code>rosparam get ${controller_ns}/root_frame</code>.</p>
<p>To send a new reference pose 0.6m above the root frame pointing into the z-direction of it, execute this:</p>
<div class="fragment"><div class="line">rostopic pub --once /${controller_ns}/reference_pose geometry_msgs/PoseStamped &quot;header:</div><div class="line">  seq: 0</div><div class="line">  stamp:</div><div class="line">    secs: 0</div><div class="line">    nsecs: 0</div><div class="line">  frame_id: &#39;&#39;</div><div class="line">pose:</div><div class="line">  position:</div><div class="line">    x: 0.0</div><div class="line">    y: 0.0</div><div class="line">    z: 0.6</div><div class="line">  orientation:</div><div class="line">    x: 0.0</div><div class="line">    y: 0.0</div><div class="line">    z: 0.0</div><div class="line">    w: 1.0&quot;</div></div><!-- fragment --><p>Most often one wants to have a controlled way to set reference poses. Once can for example use a <a href="https://git.cs.lth.se/robotlab/cartesian_trajectory_generator">trajectory generator for Cartesian trajectories</a>.</p>
<h4>Cartesian Stiffness</h4>
<p>In order to set only the Cartesian stiffnesses, once can send a <code>geometry_msgs/WrenchStamped</code> to <code>set_cartesian_stiffness</code>:</p>
<div class="fragment"><div class="line">rostopic pub --once /${controller_ns}/set_cartesian_stiffness geometry_msgs/WrenchStamped &quot;header:</div><div class="line">  seq: 0</div><div class="line">  stamp:</div><div class="line">    secs: 0</div><div class="line">    nsecs: 0</div><div class="line">  frame_id: &#39;&#39;</div><div class="line">wrench:</div><div class="line">  force:</div><div class="line">    x: 300.0</div><div class="line">    y: 300.0</div><div class="line">    z: 300.0</div><div class="line">  torque:</div><div class="line">    x: 30.0</div><div class="line">    y: 30.0</div><div class="line">    z: 30.0&quot;</div></div><!-- fragment --><h4>Cartesian Damping factors</h4>
<p>The damping factors can be configured with a <code>geometry_msgs/WrenchStamped</code> msg similar to the stiffnesses to the topic <code>${controller_ns}/set_damping_factors</code>. Damping factors are in the interval [0.01,1].</p>
<h4>Stiffnesses, damping and nullspace at once</h4>
<p>When also setting the nullspace stiffnes, a custom messages of the type <code>cartesian_impedance_controller/ControllerConfig</code> is to be sent to <code>set_config</code>:</p>
<div class="fragment"><div class="line">rostopic pub --once /${controller_ns}/set_config cartesian_impedance_controller/ControllerConfig &quot;cartesian_stiffness:</div><div class="line">  force: {x: 300.0, y: 300.0, z: 300.0}</div><div class="line">  torque: {x: 30.0, y: 30.0, z: 30.0}</div><div class="line">cartesian_damping:</div><div class="line">  force: {x: 0.0, y: 0.0, z: 0.0}</div><div class="line">  torque: {x: 0.0, y: 0.0, z: 0.0}</div><div class="line">nullspace_stiffness: 10.0</div><div class="line">nullspace_damping: 0.1</div><div class="line">q_d_nullspace: [0, 0, 0, 0, 0, 0, 0]&quot; </div></div><!-- fragment --><p><code>q_d_nullspace</code> is the nullspace joint configuration, so the joint configuration that should be achieved if the nullspace allows it. Note that the end-effector pose would deviate if the forward kinematics of this joint configuration do not overlap with it.</p>
<h4>Cartesian Wrenches</h4>
<p>A Cartesian wrench can be commanded by sending a <code>geometry_msgs/WrenchStamped</code> to the topic <code>${controller_ns}/set_cartesian_wrench</code>. Internally the wrenches are applied in the root frame. Therefore wrench messages are transformed into the root frame using <code>tf</code>.<br />
 <b>Note:</b> An empty field <code>frame_id</code> is interpreted as end-effector frame since this is the most applicable one when working with a manipulator.<br />
 <b>Note:</b> The wrenches are transformed into the root frame when they arrive, but not after that. E.g. end-effector wrenches might need to get updated.</p>
<div class="fragment"><div class="line">rostopic pub --once /${controller_ns}/set_cartesian_wrench geometry_msgs/WrenchStamped &quot;header:</div><div class="line">  seq: 0</div><div class="line">  stamp:</div><div class="line">    secs: 0</div><div class="line">    nsecs: 0</div><div class="line">  frame_id: &#39;&#39;</div><div class="line">wrench:</div><div class="line">  force:</div><div class="line">    x: 0.0</div><div class="line">    y: 0.0</div><div class="line">    z: 5.0</div><div class="line">  torque:</div><div class="line">    x: 0.0</div><div class="line">    y: 0.0</div><div class="line">    z: 0.0&quot;</div></div><!-- fragment --><h3>Trajectories and MoveIt</h3>
<p>If <code>handle_trajectories</code> is not disabled, the controller can also execute trajectories. An action server is spun up at <code>${controller_ns}/follow_joint_trajectory</code> and a fire-and-forget topic for the message type <code>trajectory_msgs/JointTrajectory</code> is at <code>${controller_ns}/joint_trajectory</code>.</p>
<p>In order to use it with <code>MoveIt</code> its controller configuration (<a href="https://github.com/epfl-lasa/iiwa_ros/blob/master/iiwa_moveit/config/EffortJointInterface_controllers.yaml">example in iiwa_ros</a>) needs to look somewhat like this: </p><div class="fragment"><div class="line">controller_list:</div><div class="line">  - name: ${controller_ns}</div><div class="line">    action_ns: follow_joint_trajectory</div><div class="line">    type: FollowJointTrajectory</div><div class="line">    default: true</div><div class="line">    joints:</div><div class="line">      - iiwa_joint_1</div><div class="line">      - iiwa_joint_2</div><div class="line">      - iiwa_joint_3</div><div class="line">      - iiwa_joint_4</div><div class="line">      - iiwa_joint_5</div><div class="line">      - iiwa_joint_6</div><div class="line">      - iiwa_joint_7</div></div><!-- fragment --><p><b>Note:</b> A nullspace stiffness needs to be specified so that the arm also follows the joint configuration and not just the end-effector pose.</p>
<h2>Safety</h2>
<p>We have used the controller with Cartesian translational stiffnesses of up to 1000 N/m and experienced it as very stable. It is also stable in singularities.</p>
<p>One additional measure can be to limit the maximum joint torques that can be applied by the robot arm in the URDF. On our KUKA iiwas we limit the maximum torque of each joint to 20 Nm, which allows a human operator to easily interfere at any time just by grabbing the arm and moving it.</p>
<p>When using <code>iiwa_ros</code>, these limits can be applied <a href="https://github.com/epfl-lasa/iiwa_ros/blob/master/iiwa_description/urdf/iiwa7.xacro#L53-L59">here</a>. For the Panda they are applied <a href="https://github.com/frankaemika/franka_ros/blob/develop/franka_description/robots/panda/joint_limits.yaml#L6">here</a>. Both arms automatically apply gravity compensation, the limits are only used for the task-level torques on top of that.</p>
<h2>Documentation</h2>
<p>The source code comes with Doxygen documentation. In a <code>catkin</code> workspace it can be built with: </p><div class="fragment"><div class="line">sudo apt-get install ros-$ROS_DISTRO-rosdoc-lite</div><div class="line">roscd cartesian_impedance_controller</div><div class="line">rosdoc_lite .</div></div><!-- fragment --><p> It can then be found in the <code>doc</code> folder with <code>doc/html/index.html</code> being the entry point.</p>
<p>The documentation for the public Github repository is automatically built and is deployed at:<br />
 <a href="https://matthias-mayr.github.io/Cartesian-Impedance-Controller/">https://matthias-mayr.github.io/Cartesian-Impedance-Controller/</a></p>
<h2>Repository and Contributions</h2>
<p>The main public code repository is at: <a href="https://github.com/matthias-mayr/Cartesian-Impedance-Controller">https://github.com/matthias-mayr/Cartesian-Impedance-Controller</a></p>
<p>Issues and pull requests are welcome. Feel free to contact the main author at <code>firstname.lastname@cs.lth.se</code> if you are using this implementation.</p>
<h2>Citing this Work</h2>
<p>A brief paper about the features and the control theory is under submission at <a href="https://joss.theoj.org/">JOSS</a>. For now there is a <a href="https://arxiv.org/abs/2212.11215">preprint on arXiv</a>.<br />
 It can be cited with his: </p><div class="fragment"><div class="line">@misc{https://doi.org/10.48550/arxiv.2212.11215,</div><div class="line">  doi = {10.48550/ARXIV.2212.11215},</div><div class="line">  url = {https://arxiv.org/abs/2212.11215},</div><div class="line">  author = {Mayr, Matthias and Salt-Ducaju, Julian M.},</div><div class="line">  keywords = {Robotics (cs.RO), FOS: Computer and information sciences, FOS: Computer and information sciences},</div><div class="line">  title = {A C++ Implementation of a Cartesian Impedance Controller for Robotic Manipulators},</div><div class="line">  publisher = {arXiv},</div><div class="line">  year = {2022}, </div><div class="line">  copyright = {Creative Commons Attribution Share Alike 4.0 International}</div><div class="line">}</div></div><!-- fragment --><h2>Troubleshooting</h2>
<h3>Compilation - A required package was not found</h3>
<p>catkin build shows this CMake Error: </p><div class="fragment"><div class="line">CMake Error at /usr/share/cmake-3.16/Modules/FindPkgConfig.cmake:463 (message):</div><div class="line">  A required package was not found</div><div class="line">Call Stack (most recent call first):</div><div class="line">  /usr/share/cmake-3.16/Modules/FindPkgConfig.cmake:643 (_pkg_check_modules_internal)</div><div class="line">  CMakeLists.txt:12 (pkg_check_modules)</div></div><!-- fragment --><p>There are missing dependencies. When replacing <code>catkin_ws</code> with your workspace, they can be resolved like this : </p><div class="fragment"><div class="line">cd catkin_ws</div><div class="line">src/cartesian_impedance_controller/scripts/install_dependencies.sh</div><div class="line">rosdep install --from-paths src --ignore-src --rosdistro=${ROS_DISTRO} -y</div></div><!-- fragment --> </div></div><!-- contents -->

<br clear="all" />
<hr size="1"><div style="align: right;">
<a href="http://wiki.ros.org/workspace">workspace</a><br />
Author(s): Matthias Mayr, Oussama Chouman</br />
<small>autogenerated on Thu Dec 22 2022 16:12:58</small>
</div>
</body>
</html>
